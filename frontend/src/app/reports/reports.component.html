<section class="page">
  <header class="page-header">
    <div>
      <h2>Reportes</h2>
      <p>Consulta y descarga el reporte mensual por DMS / DRISS / RED</p>
    </div>
    <button type="button" class="logout-btn" (click)="logout()">Salir</button>
  </header>

  <div class="filters">
    <label>
      DMS/RED LOCAL
      <select [(ngModel)]="selectedMunicipalityId">
        <option [ngValue]="null">Selecciona DMS / DRISS / RED</option>
        <option [ngValue]="'all'">DMS Y DRISS Local</option>
        <option *ngFor="let municipality of municipalities" [ngValue]="municipality.id">
          {{ municipality.name }}
        </option>
      </select>
    </label>
    <label>
      Mes
      <input type="month" [(ngModel)]="selectedMonth" />
    </label>
    <div class="filter-actions">
      <button type="button" (click)="fetchReport()">Ver reporte</button>
      <button type="button" class="secondary" (click)="downloadReport()">Descargar PDF</button>
    </div>
  </div>

  <p class="error" *ngIf="errorMessage">{{ errorMessage }}</p>

  <div class="report-card" *ngIf="report && !isLoading">
    <header>
      <h3>Reporte mensual</h3>
      <span>Total movimientos: {{ report.total_ingresos + report.total_egresos }}</span>
    </header>
    <table>
      <thead>
        <tr>
          <th>Codigo</th>
          <th>Material medico</th>
          <th>Tipo</th>
          <th>Observaciones</th>
          <th>Cantidad</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of paginatedItems">
          <td>{{ item.code }}</td>
          <td>{{ item.material_name }}</td>
          <td>{{ item.type === 'ingreso' ? 'Ingreso' : 'Egreso' }}</td>
          <td>{{ item.observations || '-' }}</td>
          <td>{{ item.quantity }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="pagination" *ngIf="report && !isLoading && (report.items?.length || 0) > 0">
    <button type="button" class="page-btn" [disabled]="currentPage === 1" (click)="changePage(-1)">
      Anterior
    </button>
    <span>Pagina {{ currentPage }} de {{ totalPages }}</span>
    <button type="button" class="page-btn" [disabled]="currentPage === totalPages" (click)="changePage(1)">
      Siguiente
    </button>
  </div>

  <div class="modal-overlay" *ngIf="showScopeModal">
    <div class="modal-card">
      <h3>Reporte consolidado</h3>
      <p>Selecciona si deseas todos los insumos o solo algunos de todos los municipios.</p>

      <div class="scope-options">
        <label class="scope-option">
          <input type="radio" name="scopeType" [(ngModel)]="scopeType" [value]="'all'" />
          Todos los insumos
        </label>
        <label class="scope-option">
          <input type="radio" name="scopeType" [(ngModel)]="scopeType" [value]="'selected'" />
          Seleccionar insumos
        </label>
      </div>

      <div class="medications-picker" *ngIf="scopeType === 'selected'">
        <label class="picker-title">Insumos disponibles</label>
        <div class="picker-list">
          <label class="picker-item" *ngFor="let medication of medications">
            <input
              type="checkbox"
              [checked]="selectedMedicationIds.has(medication.id)"
              (change)="toggleMedicationSelection(medication.id)"
            />
            {{ medication.material_name }}
          </label>
        </div>
      </div>

      <p class="error" *ngIf="scopeError">{{ scopeError }}</p>

      <div class="modal-actions">
        <button type="button" class="secondary" (click)="closeScopeModal()">Cancelar</button>
        <button type="button" (click)="continueToFormat()">Continuar</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="showAllFormatsModal">
    <div class="modal-card">
      <h3>Reporte consolidado</h3>
      <p>Selecciona el formato para descargar el reporte de todos los municipios.</p>
      <div class="modal-actions">
        <button type="button" class="secondary" (click)="closeAllFormatsModal()">Cancelar</button>
        <button type="button" (click)="downloadAllMunicipalities('pdf')">PDF</button>
        <button type="button" (click)="downloadAllMunicipalities('excel')">EXCEL</button>
      </div>
    </div>
  </div>
</section>
